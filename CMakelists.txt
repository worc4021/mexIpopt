set(CMAKE_TOOLCHAIN_FILE ${CMAKE_CURRENT_SOURCE_DIR}/vcpkg/scripts/buildsystems/vcpkg.cmake CACHE STRING "Vcpkg toolchain file")
cmake_minimum_required(VERSION 3.20)
project(ipopt_mex LANGUAGES CXX)

find_package(Matlab REQUIRED COMPONENTS MAIN_PROGRAM)

find_package(PkgConfig REQUIRED)
pkg_check_modules(ipopt REQUIRED IMPORTED_TARGET ipopt)

set(MKL_LINK "static")
set(MKL_THREADING "sequential")
set(MKL_INTERFACE_FULL "intel_lp64")
find_package(MKL REQUIRED)


add_subdirectory(MexUtilities)

matlab_add_mex(
    NAME ipopt_mex
    SRC src/main.cpp
    OUTPUT_NAME ipopt
    LINK_TO 
        MexUtilities::MexUtilities 
        libipopt.lib 
        libcoinhsl.lib
        libcoinmumps.lib 
        coinmetis.lib
        MKL::MKL
    R2018a
)

target_include_directories(ipopt_mex PRIVATE 
                            ${CMAKE_CURRENT_SOURCE_DIR}/include
                            ${ipopt_INCLUDE_DIRS})

target_link_directories(ipopt_mex PRIVATE ${ipopt_LIBRARY_DIRS})

message(STATUS "binary path: ${CMAKE_CURRENT_BINARY_DIR}")

include(CTest)
matlab_add_unit_test(NAME test_ipopt_mex
                     UNITTEST_FILE hs71.m
                     ADDITIONAL_PATH ${CMAKE_CURRENT_BINARY_DIR} ${CMAKE_CURRENT_SOURCE_DIR}/matlab)